<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forrásmegjelölés – 7–8. évfolyam – gyakorló teszt</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; line-height: 1.35; }
    body { margin: 0; background: #f6f7fb; color: #111; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .card { background: white; border-radius: 14px; padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.06); margin-bottom: 12px; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    h2 { font-size: 16px; margin: 0 0 8px; }
    .muted { color: #555; font-size: 13px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input[type="text"], input[type="password"], textarea {
      width: 100%; padding: 10px 12px; border: 1px solid #d6d8e1; border-radius: 10px; font-size: 14px; box-sizing: border-box;
      background: #fff;
    }
    textarea { min-height: 70px; resize: vertical; }
    button {
      border: 0; border-radius: 10px; padding: 10px 12px; font-size: 14px; cursor: pointer;
      background: #1f6feb; color: #fff;
    }
    button.secondary { background: #2f3542; }
    button.ghost { background: #e9ecf6; color: #111; }
    button.danger { background: #d7263d; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .q { padding: 12px; border: 1px solid #eceef6; border-radius: 12px; margin-top: 10px; }
    .q-title { font-weight: 700; margin: 0 0 8px; }
    .opt { display: block; padding: 8px 10px; border: 1px solid #eceef6; border-radius: 10px; margin: 6px 0; background: #fafbff; }
    .opt input { margin-right: 8px; }
    .badge { display:inline-block; padding: 4px 8px; border-radius: 999px; background:#eef3ff; font-size: 12px; }
    .ok { color: #0a7a2f; font-weight: 700; }
    .err { color: #b00020; font-weight: 700; }
    .hr { height: 1px; background: #eceef6; margin: 10px 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eceef6; padding: 8px; text-align: left; font-size: 13px; vertical-align: top; }
    th { background: #fafbff; position: sticky; top: 0; z-index: 1; }
    .small { font-size: 12px; }
    .hidden { display:none !important; }
    .right { margin-left: auto; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#fafbff; border:1px solid #eceef6; font-size:12px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h1>Forrásmegjelölés – 7–8. évfolyam – gyakorló teszt</h1>
          <div class="muted">Név → kitöltés → beküldés → eredmény + magyarázat. (Később Firestore-ba menthető.)</div>
        </div>
        <div class="right row">
          <button id="btnTeacher" class="secondary" type="button">Tanári nézet</button>
          <button id="btnResetLocal" class="ghost" type="button" title="Ha elrontották a nevet vagy újra akarja tölteni ugyanazon a gépen.">Helyi újrakezdés</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="status" class="muted">Állapot: betöltés…</div>
    </div>

    <!-- STUDENT START -->
    <div id="studentStart" class="card">
      <h2>1) Add meg a neved</h2>
      <div class="muted">Pl.: „Dóra 8.a”.</div>
      <div class="row" style="margin-top:10px;">
        <div style="flex: 1 1 280px;">
          <input id="studentName" type="text" placeholder="Név" autocomplete="off" />
        </div>
        <div>
          <button id="btnStart" type="button">Kezdés</button>
        </div>
      </div>
      <div id="nameError" class="err small hidden" style="margin-top:8px;">Kérlek, írj be nevet (legalább 2 karakter).</div>
    </div>

    <!-- QUIZ -->
    <div id="quiz" class="card hidden">
      <div class="row">
        <div class="badge" id="progressBadge">0 / 0</div>
        <div class="muted" id="quizHint">Válaszolj minden kérdésre. Az „Igen/Nem” részhez írj 1–2 mondat indoklást.</div>
      </div>

      <div id="questions"></div>

      <div class="hr"></div>
      <div class="row">
        <button id="btnSubmit" type="button">Beküldés és eredmény</button>
        <div class="muted" id="submitInfo">Beküldéskor a válaszok menthetők Firestore-ba (ha beállítod).</div>
      </div>
      <div id="submitError" class="err small hidden" style="margin-top:8px;"></div>
    </div>

    <!-- RESULT -->
    <div id="result" class="card hidden">
      <h2>Eredmény</h2>
      <div id="resultSummary" class="muted"></div>
      <div class="hr"></div>
      <div id="resultFeedback"></div>
      <div class="hr"></div>
      <div class="muted small">
        Megjegyzés: Az indoklásokat a tanár a „Tanári nézetben” is láthatja (ha a Firestore mentés be van állítva).
      </div>
    </div>

    <!-- TEACHER -->
    <div id="teacher" class="card hidden">
      <h2>Tanári nézet</h2>
      <div class="muted">Egyszerű jelszavas UI-védelem. (Nem helyettesít valódi jogosultságkezelést.)</div>
      <div class="row" style="margin-top:10px;">
        <div style="flex: 1 1 240px;">
          <input id="teacherPass" type="password" placeholder="Tanári jelszó" autocomplete="off" />
        </div>
        <div class="row">
          <button id="btnTeacherLogin" type="button">Belépés</button>
          <button id="btnTeacherClose" class="ghost" type="button">Bezár</button>
        </div>
      </div>
      <div id="teacherAuthError" class="err small hidden" style="margin-top:8px;">Hibás jelszó.</div>

      <div id="teacherPanel" class="hidden" style="margin-top:14px;">
        <div class="row">
          <div class="muted"><span class="badge" id="countBadge">0</span> beküldés</div>
          <div class="right row">
            <button id="btnRefresh" class="ghost" type="button">Frissítés</button>
            <button id="btnExport" class="secondary" type="button">CSV export</button>
            <button id="btnDeleteAll" class="danger" type="button">Összes törlése</button>
          </div>
        </div>
        <div class="hr"></div>
        <div style="max-height: 520px; overflow:auto; border:1px solid #eceef6; border-radius: 12px;">
          <table id="submissionsTable">
            <thead>
              <tr>
                <th>Idő</th>
                <th>Név</th>
                <th>Pont</th>
                <th>MCQ</th>
                <th>Igen/Nem + indoklás</th>
                <th>Művelet</th>
              </tr>
            </thead>
            <tbody id="submissionsBody"></tbody>
          </table>
        </div>
        <div class="muted small" style="margin-top:8px;">
          Tipp: ha sok beküldés van, a kód az utolsó 200-at tölti be.
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    /*********************************************************************
     * 0) BEÁLLÍTÁSOK
     *********************************************************************/
    const TEACHER_PASSWORD = "TanAr78!"; // <-- ezt később átírhatod

    // ✅ IDE majd a forras-78 Firebase projekt configját másolod be
    // (Most még hagyhatod így: a teszt akkor is lefut, csak nem fog menteni.)
    const firebaseConfig = {
      apiKey: "PASTE_API_KEY",
      authDomain: "PASTE_AUTH_DOMAIN",
      projectId: "PASTE_PROJECT_ID",
      storageBucket: "PASTE_STORAGE_BUCKET",
      messagingSenderId: "PASTE_SENDER_ID",
      appId: "PASTE_APP_ID"
    };

    const COLLECTION = "forras78_submissions";
    const VERSION = "forras_78_v1";

    /*********************************************************************
     * 1) FIREBASE IMPORTS (CDN-es – single HTML-hez ez kell)
     *********************************************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit,
      getDocs, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    /*********************************************************************
     * 2) DOM helpers
     *********************************************************************/
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove("hidden");
    const hide = (el) => el.classList.add("hidden");
    const setText = (el, t) => (el.textContent = t);

    /*********************************************************************
     * 3) KÉRDÉSEK (7–8. évfolyam) – 20 db
     *    - 10 MCQ (4 opció, nehezebb/döntésközeli)
     *    - 10 Igen/Nem + 1–2 mondatos indoklás
     *********************************************************************/
    const mcq = [
      {
        id: "mcq1",
        q: "Melyik forrásmegjelölés a LEGPONTOSABB egy weboldalhoz?",
        options: [
          "Forrás: internet",
          "A weboldal neve + a konkrét cikk címe + link + (ha elérhető: dátum)",
          "Forrás: Google",
          "Wikipédia"
        ],
        correctIndex: 1,
        explain: "A forrást azonosíthatóvá kell tenni: hol, pontosan melyik tartalom, és hogyan érhető el."
      },
      {
        id: "mcq2",
        q: "Mi a legnagyobb gond a „Forrás: Wikipédia” megjelöléssel?",
        options: [
          "Túl hosszú",
          "Nem lehet belőle tanulni",
          "Túl sok benne a kép",
          "Nem elég pontos: nem derül ki, melyik szócikk/oldal"
        ],
        correctIndex: 3,
        explain: "Önmagában nem azonosítja a konkrét oldalt, ezért ellenőrizhetetlen/hiányos."
      },
      {
        id: "mcq3",
        q: "Mikor kötelező idézőjelet használni?",
        options: [
          "Ha szó szerint átveszel egy mondatot vagy kifejezést",
          "Ha a szöveg rövid (1–2 mondat)",
          "Ha a szöveg képekkel együtt van",
          "Ha a tanár kéri"
        ],
        correctIndex: 0,
        explain: "Az idézőjel a szó szerinti átvételt jelzi; mellé forrás is kell."
      },
      {
        id: "mcq4",
        q: "Egy blogbejegyzést használsz. Mi a legjobb lépés a megbízhatóság ellenőrzésére?",
        options: [
          "Ha sokan megosztották, biztos igaz",
          "Megnézed, ki a szerző, milyen háttere van, és van-e hivatkozás/ellenőrizhető adat",
          "Ha jól hangzik, elég",
          "Ha rövid, akkor megbízhatóbb"
        ],
        correctIndex: 1,
        explain: "A szerző, cél, bizonyítékok és ellenőrizhetőség a lényeg, nem a népszerűség."
      },
      {
        id: "mcq5",
        q: "Miért félrevezető azt írni: „Forrás: Google”?",
        options: [
          "A Google fizetős",
          "A Google kereső, nem az információ eredeti forrása",
          "A Google tiltja a hivatkozást",
          "A Google csak képeket mutat"
        ],
        correctIndex: 1,
        explain: "A kereső csak elvezet a forráshoz; a forrás az a konkrét oldal/könyv/videó."
      },
      {
        id: "mcq6",
        q: "A tanuló több oldalból dolgozott, de csak egyet tüntet fel. Melyik a legjobb értékelés?",
        options: [
          "Rendben van, ha az az egyik oldal jó",
          "Nem gond, úgysem ellenőrzi senki",
          "Nem korrekt: minden ténylegesen használt forrást fel kell tüntetni",
          "Csak akkor gond, ha szó szerint másolt"
        ],
        correctIndex: 2,
        explain: "A forráslista a felhasznált forrásokat tükrözi, nem „dísz”."
      },
      {
        id: "mcq7",
        q: "Mitől lesz egy kép felhasználása korrektebb?",
        options: [
          "Ha levágod a vízjelet",
          "Ha csak iskolára használod",
          "Ha aláírod: honnan van (oldal/szerző) és szükség esetén a licencet is figyelembe veszed",
          "Ha átméretezed"
        ],
        correctIndex: 2,
        explain: "A forrás és a felhasználási feltételek (licenc) számítanak, nem a szerkesztés."
      },
      {
        id: "mcq8",
        q: "Melyik állítás a LEGPONTOSABB az „áttanulás” (parafrázis) esetén?",
        options: [
          "Ha saját szavaimmal írok, soha nem kell forrás",
          "Ha saját szavaimmal írok, a forrás megjelölése továbbra is ajánlott/korrekt",
          "Ha átírok 1–2 szót, az már saját",
          "Ha rövidítek, az már saját"
        ],
        correctIndex: 1,
        explain: "A gondolat eredete ugyanaz marad; a forrás jelölése ettől még fontos."
      },
      {
        id: "mcq9",
        q: "Melyik forrás a legkockázatosabb tényállításokra hivatkozásként?",
        options: [
          "Tankönyv",
          "Ismeretterjesztő cikk szerzővel",
          "Névtelen komment egy közösségi oldalon",
          "Könyv szerzővel és kiadóval"
        ],
        correctIndex: 2,
        explain: "A névtelen komment ellenőrizhetetlen és gyakran vélemény, nem ellenőrzött tény."
      },
      {
        id: "mcq10",
        q: "Mi a legjobb gyakorlat, ha két forrás ellentmond egymásnak?",
        options: [
          "Azt választod, amelyik tetszik",
          "Azt választod, amelyik rövidebb",
          "Jelzed az eltérést, és megbízhatóbb/elsődleges forrás után nézel",
          "Nem jelölsz forrást, úgy egyszerűbb"
        ],
        correctIndex: 2,
        explain: "Az eltérés jelzése és a megbízhatóság ellenőrzése a kritikus forráshasználat része."
      }
    ];

    const yn = [
      {
        id: "yn1",
        q: "Helyes-e: „Forrás: Wikipédia” (link és szócikk nélkül)?",
        correctYes: false,
        why: "Nem elég pontos: a konkrét szócikk címe és linkje (és lehetőleg dátum) kell az ellenőrizhetőséghez."
      },
      {
        id: "yn2",
        q: "Helyes-e: Szó szerint átmásolsz egy mondatot, idézőjelbe teszed, és odaírod a weboldal nevét + linket?",
        correctYes: true,
        why: "Igen: az idézőjel jelzi a szó szerinti átvételt, a forrás pedig tisztességesen azonosítja az eredetet."
      },
      {
        id: "yn3",
        q: "Helyes-e: Képet használsz egy oldalról, de nem jelölöd a forrást, mert „csak illusztráció”?",
        correctYes: false,
        why: "Nem: a kép is forrásból származik; a forrás és a felhasználási feltételek fontosak."
      },
      {
        id: "yn4",
        q: "Helyes-e: AI segített megfogalmazni a szöveget, és ezt a tanuló jelzi a munka végén (pl. „fogalmazásban AI segített”)?",
        correctYes: true,
        why: "Igen: átláthatóvá teszi a segítséget, ami etikai szempontból korrekt (különösen iskolai munkában)."
      },
      {
        id: "yn5",
        q: "Helyes-e: Olyan forrást tüntetsz fel, amit valójában nem használtál, „hogy komolyabbnak tűnjön”?",
        correctYes: false,
        why: "Nem: félrevezető, a forráslista a ténylegesen használt anyagokat kell tükrözze."
      },
      {
        id: "yn6",
        q: "Helyes-e: Saját szavaiddal írsz, de a végén felsorolod a használt könyveket/oldalakat?",
        correctYes: true,
        why: "Igen: a gondolat/infó eredete így is jelölhető, ez erősíti a munka korrektségét."
      },
      {
        id: "yn7",
        q: "Helyes-e: Egy TikTok-videót használsz tényállításokra, és nem ellenőrzöd más forrásból?",
        correctYes: false,
        why: "Nem: rövid videóknál gyakori a pontatlanság; tényeket érdemes megbízhatóbb forrásból ellenőrizni."
      },
      {
        id: "yn8",
        q: "Helyes-e: A „Google” szót írod forrásnak, mert onnan találtad?",
        correctYes: false,
        why: "Nem: a Google kereső; a forrás az a konkrét oldal/könyv/videó, ahol az információ ténylegesen van."
      },
      {
        id: "yn9",
        q: "Helyes-e: Két forrás ellentmond; ezt jelzed a munkában, és megírod, melyiket tartod megbízhatóbbnak (indokkal)?",
        correctYes: true,
        why: "Igen: ez kritikus forráshasználat; az eltérés jelzése és indoklás értékes."
      },
      {
        id: "yn10",
        q: "Helyes-e: A forráslista végére ezt írod: „források: internet, könyvek”?",
        correctYes: false,
        why: "Nem: túl általános, nem ellenőrizhető. Konkrét címek/szerzők/linkek kellenek."
      }
    ];

    const totalAutoPoints = mcq.length + yn.length;

    /*********************************************************************
     * 4) APP STATE
     *********************************************************************/
    let db = null;
    let student = {
      name: "",
      answers: {},
      justifications: {},
      score: 0,
      maxScore: totalAutoPoints
    };

    function safeNowISO() {
      return new Date().toISOString();
    }

    /*********************************************************************
     * 5) RENDER QUESTIONS
     *********************************************************************/
    function renderQuestions() {
      const holder = $("questions");
      holder.innerHTML = "";

      const mcqHeader = document.createElement("div");
      mcqHeader.className = "q";
      mcqHeader.innerHTML = `
        <div class="q-title">A) Feleletválasztós (10 kérdés) – válassz 1-et</div>
        <div class="muted small">Figyelj: több válasz „majdnem jó” lehet, de csak 1 a legjobb.</div>`;
      holder.appendChild(mcqHeader);

      mcq.forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "q";
        div.innerHTML = `<div class="q-title">${idx+1}. ${item.q}</div>`;
        item.options.forEach((opt, oi) => {
          const id = `${item.id}_${oi}`;
          const lab = document.createElement("label");
          lab.className = "opt";
          lab.innerHTML = `<input type="radio" name="${item.id}" id="${id}" value="${oi}"> ${escapeHtml(opt)}`;
          div.appendChild(lab);
        });
        holder.appendChild(div);
      });

      const ynHeader = document.createElement("div");
      ynHeader.className = "q";
      ynHeader.innerHTML = `
        <div class="q-title">B) Igen / Nem + indoklás (10 kérdés)</div>
        <div class="muted small">Válaszd ki, hogy helyes-e, és írj 1–2 mondatban indoklást.</div>`;
      holder.appendChild(ynHeader);

      yn.forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "q";
        div.innerHTML = `<div class="q-title">${idx+1}. ${escapeHtml(item.q)}</div>`;

        div.innerHTML += `
          <label class="opt"><input type="radio" name="${item.id}" value="yes"> Igen</label>
          <label class="opt"><input type="radio" name="${item.id}" value="no"> Nem</label>
          <div class="muted small" style="margin-top:8px;">Indoklás (1–2 mondat):</div>
          <textarea id="${item.id}_why" placeholder="Írj 1–2 mondatot: miért igen / miért nem."></textarea>
        `;
        holder.appendChild(div);
      });

      setText($("progressBadge"), `20 kérdés = ${totalAutoPoints} automatikus pont`);
    }

    function collectAnswers() {
      const answers = {};
      const just = {};

      mcq.forEach((item) => {
        const checked = document.querySelector(`input[name="${item.id}"]:checked`);
        answers[item.id] = checked ? Number(checked.value) : null;
      });

      yn.forEach((item) => {
        const checked = document.querySelector(`input[name="${item.id}"]:checked`);
        answers[item.id] = checked ? checked.value : null;
        just[item.id] = ($(`${item.id}_why`).value || "").trim();
      });

      return { answers, justifications: just };
    }

    function validateBeforeSubmit(payload) {
      for (const item of mcq) {
        if (payload.answers[item.id] === null) return `Hiányzik válasz: "${item.q}"`;
      }
      for (const item of yn) {
        if (payload.answers[item.id] === null) return `Hiányzik Igen/Nem válasz: "${item.q}"`;
        const t = payload.justifications[item.id] || "";
        if (t.length < 12 || !t.includes(" ")) return `Kérlek, írj 1–2 mondatos indoklást ennél: "${item.q}"`;
      }
      return null;
    }

    function computeScore(answers) {
      let s = 0;
      mcq.forEach((item) => {
        if (answers[item.id] === item.correctIndex) s += 1;
      });
      yn.forEach((item) => {
        const isYes = answers[item.id] === "yes";
        const correct = (isYes === item.correctYes);
        if (correct) s += 1;
      });
      return s;
    }

    function buildFeedback(payload) {
      const out = document.createElement("div");

      const p1 = document.createElement("div");
      p1.className = "q";
      p1.innerHTML = `
        <div class="q-title">Visszajelzés és magyarázat</div>
        <div class="muted small">A cél: értsd, miért helyes vagy miért nem helyes egy megoldás.</div>`;
      out.appendChild(p1);

      // MCQ: list wrongs
      const mcqBlock = document.createElement("div");
      mcqBlock.className = "q";
      mcqBlock.innerHTML = `<div class="q-title">A) Feleletválasztós – magyarázat</div>`;

      let mcqWrong = 0;
      mcq.forEach((item, i) => {
        const a = payload.answers[item.id];
        const ok = (a === item.correctIndex);
        if (!ok) mcqWrong++;

        const yourText = (a === null) ? "(nincs válasz)" : item.options[a];
        const correctText = item.options[item.correctIndex];

        const line = document.createElement("div");
        line.style.marginTop = "10px";
        line.innerHTML = `
          <div><span class="${ok ? "ok" : "err"}">${ok ? "Jó" : "Nem jó"}</span>
          <span class="pill">MCQ ${i+1}</span> – ${escapeHtml(item.q)}</div>
          ${ok ? "" : `<div class="small muted">A te válaszod: <b>${escapeHtml(yourText)}</b></div>`}
          <div class="small muted">Helyes: <b>${escapeHtml(correctText)}</b></div>
          <div class="small muted">Miért: ${escapeHtml(item.explain)}</div>
        `;
        mcqBlock.appendChild(line);
      });
      out.appendChild(mcqBlock);

      // YN
      const ynBlock = document.createElement("div");
      ynBlock.className = "q";
      ynBlock.innerHTML = `<div class="q-title">B) Igen/Nem – „miért igen / miért nem”</div>`;

      yn.forEach((item, i) => {
        const ans = payload.answers[item.id];
        const isYes = ans === "yes";
        const ok = (isYes === item.correctYes);
        const correctText = item.correctYes ? "Igen" : "Nem";
        const yourText = (ans === null) ? "(nincs válasz)" : (ans === "yes" ? "Igen" : "Nem");
        const yourWhy = payload.justifications[item.id] || "";

        const line = document.createElement("div");
        line.style.marginTop = "10px";
        line.innerHTML = `
          <div><span class="${ok ? "ok" : "err"}">${ok ? "Jó" : "Nem jó"}</span>
          <span class="pill">YN ${i+1}</span> – ${escapeHtml(item.q)}</div>
          <div class="small muted">A te válaszod: <b>${escapeHtml(yourText)}</b></div>
          <div class="small muted">A te indoklásod: <b>${escapeHtml(yourWhy || "(nincs indoklás)")}</b></div>
          <div class="small muted">Helyes válasz: <b>${escapeHtml(correctText)}</b></div>
          <div class="small muted">Miért: ${escapeHtml(item.why)}</div>
        `;
        ynBlock.appendChild(line);
      });
      out.appendChild(ynBlock);

      return out;
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    /*********************************************************************
     * 6) FIRESTORE (mentés – csak ha be van állítva a config)
     *********************************************************************/
    function looksConfigured(cfg) {
      // ha nincs beállítva, marad a "PASTE_..."
      return cfg && Object.values(cfg).every(v => typeof v === "string" && v && !v.startsWith("PASTE_"));
    }

    function initFirebase() {
      try {
        if (!looksConfigured(firebaseConfig)) {
          db = null;
          setText($("status"), "Állapot: Firebase NINCS beállítva (a teszt működik, de nem ment).");
          return;
        }
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        setText($("status"), "Állapot: Firebase OK (Firestore mentés aktív).");
      } catch (e) {
        console.error(e);
        db = null;
        setText($("status"), "Állapot: Firebase hiba – ellenőrizd a firebaseConfig-ot.");
      }
    }

    async function saveSubmission(payload) {
      if (!db) return null; // mentés nélkül is működjön
      const docData = {
        studentName: student.name,
        createdAt: serverTimestamp(),
        createdAtClient: safeNowISO(),
        score: student.score,
        maxScore: student.maxScore,
        answers: payload.answers,
        justifications: payload.justifications,
        version: VERSION
      };
      const ref = await addDoc(collection(db, COLLECTION), docData);
      return ref.id;
    }

    /*********************************************************************
     * 7) TANÁRI NÉZET
     *********************************************************************/
    async function loadSubmissions() {
      if (!db) throw new Error("Nincs Firestore kapcsolat (nincs beállítva a firebaseConfig).");
      const qy = query(collection(db, COLLECTION), orderBy("createdAtClient", "desc"), limit(200));
      const snap = await getDocs(qy);
      const rows = [];
      snap.forEach(d => rows.push({ id: d.id, ...d.data() }));
      return rows;
    }

    function formatTime(row) {
      const s = row.createdAtClient || "";
      return s ? s.replace("T"," ").replace("Z","") : "";
    }

    function summarizeMCQ(row) {
      let correct = 0;
      for (const item of mcq) {
        if (row.answers && row.answers[item.id] === item.correctIndex) correct++;
      }
      return `${correct}/${mcq.length}`;
    }

    function summarizeYN(row) {
      let correct = 0;
      const lines = [];
      yn.forEach((item, i) => {
        const a = row.answers ? row.answers[item.id] : null;
        const isYes = a === "yes";
        const ok = (isYes === item.correctYes);
        if (ok) correct++;
        const why = (row.justifications && row.justifications[item.id]) ? row.justifications[item.id] : "";
        lines.push(`${i+1}) ${ok ? "✓" : "✗"} – ${why}`);
      });
      return { correct, text: lines.join("\n") };
    }

    function renderTeacherTable(rows) {
      const body = $("submissionsBody");
      body.innerHTML = "";
      setText($("countBadge"), String(rows.length));

      rows.forEach(row => {
        const tr = document.createElement("tr");
        const ynSum = summarizeYN(row);

        const tdTime = document.createElement("td");
        tdTime.textContent = formatTime(row);

        const tdName = document.createElement("td");
        tdName.textContent = row.studentName || "";

        const tdScore = document.createElement("td");
        tdScore.innerHTML = `<b>${row.score ?? "?"}</b> / ${row.maxScore ?? totalAutoPoints}
          <div class="small muted">MCQ: ${summarizeMCQ(row)} | YN: ${ynSum.correct}/${yn.length}</div>`;

        const tdMCQ = document.createElement("td");
        tdMCQ.textContent = summarizeMCQ(row);

        const tdYN = document.createElement("td");
        tdYN.innerHTML = `<pre style="white-space:pre-wrap; margin:0; font-family: inherit; font-size:12px;">${escapeHtml(ynSum.text)}</pre>`;

        const tdAct = document.createElement("td");
        const btnDel = document.createElement("button");
        btnDel.className = "danger";
        btnDel.textContent = "Törlés";
        btnDel.onclick = async () => {
          if (!confirm(`Törlöd ezt a beküldést? (${row.studentName || "név nélkül"})`)) return;
          await deleteDoc(doc(db, COLLECTION, row.id));
          await refreshTeacher();
        };
        tdAct.appendChild(btnDel);

        tr.appendChild(tdTime);
        tr.appendChild(tdName);
        tr.appendChild(tdScore);
        tr.appendChild(tdMCQ);
        tr.appendChild(tdYN);
        tr.appendChild(tdAct);

        body.appendChild(tr);
      });
    }

    async function refreshTeacher() {
      try {
        const rows = await loadSubmissions();
        renderTeacherTable(rows);
      } catch (e) {
        alert("Tanári nézet hiba: " + (e?.message || String(e)));
      }
    }

    function csvCell(v) {
      const s = String(v ?? "");
      const needs = /[",\n]/.test(s);
      const esc = s.replaceAll('"','""');
      return needs ? `"${esc}"` : esc;
    }

    function exportCSVFromTable() {
      const rows = [];
      const header = ["Idő","Név","Pont","MaxPont","MCQ_összegzés","YN_indoklások"];
      rows.push(header);

      const trs = Array.from($("submissionsBody").querySelectorAll("tr"));
      trs.forEach(tr => {
        const tds = Array.from(tr.querySelectorAll("td"));
        const time = tds[0]?.innerText?.trim() ?? "";
        const name = tds[1]?.innerText?.trim() ?? "";
        const scoreLine = tds[2]?.innerText?.trim() ?? "";
        const firstLine = scoreLine.split("\n")[0] || "";
        const m = firstLine.match(/(\d+)\s*\/\s*(\d+)/);
        const score = m ? m[1] : "";
        const max = m ? m[2] : "";
        const mcqSum = tds[3]?.innerText?.trim() ?? "";
        const ynText = tds[4]?.innerText?.trim() ?? "";
        rows.push([time,name,score,max,mcqSum,ynText].map(csvCell));
      });

      const csv = rows.map(r => r.join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "forras78_eredmenyek.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function deleteAllSubmissions() {
      if (!confirm("Biztosan törlöd AZ ÖSSZES beküldést? Ez nem visszavonható.")) return;
      if (!confirm("Második megerősítés: tényleg minden beküldést törlünk?")) return;

      try {
        const rows = await loadSubmissions();
        for (const r of rows) {
          await deleteDoc(doc(db, COLLECTION, r.id));
        }
        await refreshTeacher();
        alert("Kész: törölve.");
      } catch (e) {
        alert("Hiba törléskor: " + (e?.message || String(e)));
      }
    }

    /*********************************************************************
     * 8) UI
     *********************************************************************/
    function resetLocal() {
      localStorage.removeItem("forras78_name");
      localStorage.removeItem("forras78_submitted");
      location.reload();
    }

    function loadNameIfAny() {
      const n = localStorage.getItem("forras78_name");
      if (n) $("studentName").value = n;
    }

    function markSubmitted() {
      localStorage.setItem("forras78_submitted", "1");
    }

    function alreadySubmitted() {
      return localStorage.getItem("forras78_submitted") === "1";
    }

    function startQuiz() {
      const name = ($("studentName").value || "").trim();
      if (name.length < 2) {
        show($("nameError"));
        return;
      }
      hide($("nameError"));
      student.name = name;
      localStorage.setItem("forras78_name", name);

      hide($("studentStart"));
      show($("quiz"));
      renderQuestions();

      if (alreadySubmitted()) {
        $("submitInfo").textContent = "Megjegyzés: ezen a gépen már volt beküldés. Ha újra kell kezdeni, kattints a „Helyi újrakezdés”-re.";
      }
    }

    async function submitQuiz() {
      hide($("submitError"));

      const payload = collectAnswers();
      const err = validateBeforeSubmit(payload);
      if (err) {
        $("submitError").textContent = err;
        show($("submitError"));
        return;
      }

      student.answers = payload.answers;
      student.justifications = payload.justifications;
      student.score = computeScore(payload.answers);

      $("btnSubmit").disabled = true;
      $("btnSubmit").textContent = "Mentés/kiértékelés…";

      try {
        const id = await saveSubmission(payload);
        markSubmitted();

        hide($("quiz"));
        show($("result"));

        $("resultSummary").innerHTML = `
          Név: <b>${escapeHtml(student.name)}</b><br>
          Automatikus pontszám: <b>${student.score}</b> / ${student.maxScore}<br>
          ${id ? `Mentés azonosító: <span class="badge">${escapeHtml(id)}</span>` : `<span class="badge">Mentés: kikapcsolva</span>`}
        `;

        const fb = buildFeedback(payload);
        $("resultFeedback").innerHTML = "";
        $("resultFeedback").appendChild(fb);

      } catch (e) {
        console.error(e);
        $("submitError").textContent = "Kiértékelési/mentési hiba. (Ha nincs beállítva a firebaseConfig, ez normális lehet.)";
        show($("submitError"));
      } finally {
        $("btnSubmit").disabled = false;
        $("btnSubmit").textContent = "Beküldés és eredmény";
      }
    }

    function openTeacher() {
      show($("teacher"));
      $("teacherPass").value = "";
      hide($("teacherAuthError"));
      hide($("teacherPanel"));
    }

    function closeTeacher() {
      hide($("teacher"));
    }

    function teacherLogin() {
      const pw = $("teacherPass").value || "";
      if (pw !== TEACHER_PASSWORD) {
        show($("teacherAuthError"));
        return;
      }
      hide($("teacherAuthError"));
      show($("teacherPanel"));
      refreshTeacher();
    }

    // init
    initFirebase();
    loadNameIfAny();

    $("btnStart").addEventListener("click", startQuiz);
    $("btnSubmit").addEventListener("click", submitQuiz);
    $("btnTeacher").addEventListener("click", openTeacher);
    $("btnTeacherClose").addEventListener("click", closeTeacher);
    $("btnTeacherLogin").addEventListener("click", teacherLogin);
    $("btnRefresh").addEventListener("click", refreshTeacher);
    $("btnExport").addEventListener("click", exportCSVFromTable);
    $("btnDeleteAll").addEventListener("click", deleteAllSubmissions);
    $("btnResetLocal").addEventListener("click", resetLocal);

    $("studentName").addEventListener("keydown", (e) => {
      if (e.key === "Enter") startQuiz();
    });
    $("teacherPass").addEventListener("keydown", (e) => {
      if (e.key === "Enter") teacherLogin();
    });
  </script>
</body>
</html>
